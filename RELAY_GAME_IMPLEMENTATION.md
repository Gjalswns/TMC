# Relay Game 구현 완료

## 🎯 게임 메커니즘

### 기본 구조
- **문제 세트**: P, Q, R, S (4개 세트)
- **각 세트당 문제**: 4개 (1, 2, 3, 4번)
- **팀 구성**: 4명 (A, B, C, D)
- **총 라운드**: 4라운드 (사이클)

### 진행 방식

#### 라운드 1 (Cycle 1)
```
A → P-1 (힌트 없음)
B → Q-1 (힌트 없음)
C → R-1 (힌트 없음)
D → S-1 (힌트 없음)
```

#### 라운드 2 (Cycle 2)
```
A → Q-2 (힌트: P-1 정답)
B → R-2 (힌트: Q-1 정답)
C → S-2 (힌트: R-1 정답)
D → P-2 (힌트: S-1 정답)
```

#### 라운드 3 (Cycle 3)
```
A → R-3 (힌트: P-1, Q-2 정답)
B → S-3 (힌트: Q-1, R-2 정답)
C → P-3 (힌트: R-1, S-2 정답)
D → Q-3 (힌트: S-1, P-2 정답)
```

#### 라운드 4 (Cycle 4)
```
A → S-4 (힌트: P-1, Q-2, R-3 정답)
B → P-4 (힌트: Q-1, R-2, S-3 정답)
C → Q-4 (힌트: R-1, S-2, P-3 정답)
D → R-4 (힌트: S-1, P-2, Q-3 정답)
```

### 순환 패턴
```
학생 A: P → Q → R → S
학생 B: Q → R → S → P
학생 C: R → S → P → Q
학생 D: S → P → Q → R
```

## 💡 힌트 페널티 시스템

### 문제 상황
- 이전 팀원이 문제를 틀렸을 수 있음
- 틀린 정답을 힌트로 받으면 다음 문제도 틀릴 위험

### 해결책: 힌트 확인 버튼
**"이전 올바른 정답 확인하기"** 버튼 제공

#### 작동 방식
1. 버튼 클릭
2. 확인 다이얼로그 표시
3. 확인 시:
   - ❌ **-100점 감점**
   - ✅ **올바른 정답 공개**
   - 📝 **힌트 사용 기록 저장**

#### 재사용
- 같은 힌트를 다시 확인할 때는 **추가 감점 없음**
- 이미 공개된 정답은 무료로 다시 볼 수 있음

### 전략적 선택
```
상황: 이전 정답이 의심스러움

선택 A: 추측해서 풀기
  - 장점: 감점 없음
  - 단점: 틀릴 위험

선택 B: -100점 받고 정답 확인
  - 장점: 확실한 정답 확보
  - 단점: 100점 손실
```

## 🗄️ 데이터베이스 구조

### 새로 추가된 테이블

#### `relay_quiz_hint_usage`
```sql
- id: UUID (PK)
- session_id: UUID (FK)
- team_id: UUID (FK)
- participant_id: UUID (FK)
- cycle_number: INTEGER
- question_order: INTEGER
- revealed_answer: TEXT
- penalty_points: INTEGER (-100)
- used_at: TIMESTAMP
```

### 수정된 테이블

#### `relay_quiz_team_progress`
추가된 컬럼:
- `hints_used`: INTEGER - 사용한 힌트 개수
- `hint_penalty_total`: INTEGER - 총 힌트 페널티
- `revealed_answers`: JSONB - 공개된 정답 목록

## 🔧 주요 함수

### 1. `use_relay_quiz_hint()`
이전 정답 확인 (-100점)

**파라미터:**
- `p_session_id`: 세션 ID
- `p_team_id`: 팀 ID
- `p_participant_id`: 참가자 ID
- `p_question_order`: 확인할 문제 순서

**반환값:**
- `hint_id`: 힌트 사용 기록 ID
- `revealed_answer`: 공개된 정답
- `penalty_points`: 페널티 점수 (-100)
- `new_total_score`: 새로운 총점
- `success`: 성공 여부
- `message`: 메시지

### 2. `get_available_hints()`
사용 가능한 힌트 목록 조회

**파라미터:**
- `p_session_id`: 세션 ID
- `p_team_id`: 팀 ID

**반환값:**
- `question_order`: 문제 순서
- `can_reveal`: 공개 가능 여부
- `already_revealed`: 이미 공개됨
- `revealed_answer`: 공개된 정답 (있는 경우)
- `penalty_points`: 페널티 점수

### 3. `submit_relay_quiz_answer_with_hints()`
답안 제출 (힌트 정보 포함)

**파라미터:**
- `p_session_id`: 세션 ID
- `p_team_id`: 팀 ID
- `p_participant_id`: 참가자 ID
- `p_answer`: 답안

**반환값:**
- `attempt_id`: 시도 ID
- `is_correct`: 정답 여부
- `is_cycle_complete`: 사이클 완료 여부
- `next_question_order`: 다음 문제 순서
- `available_hints`: 사용 가능한 힌트 (JSONB)
- `success`: 성공 여부
- `message`: 메시지

## 🎨 UI 구성 (예시)

```
┌─────────────────────────────────────────────┐
│ Relay Quiz - Cycle 3                        │
│ 현재 문제: R-3                               │
├─────────────────────────────────────────────┤
│ 이전 정답 힌트:                              │
│                                              │
│ P-1: "42" [확인하기 -100점] ⚠️              │
│ Q-2: "정답 확인됨: 78" ✅                    │
│                                              │
├─────────────────────────────────────────────┤
│ 문제: 다음 수열의 다음 숫자는?              │
│ 1, 1, 2, 3, 5, 8, ?                         │
│                                              │
│ 답안: [_____________]                       │
│                                              │
│ [제출하기]                                   │
└─────────────────────────────────────────────┘

팀 점수: 850점
힌트 사용: 1회 (-100점)
```

## 📊 점수 계산

### 기본 점수
- 정답: +문제 배점 (예: 100점)
- 오답: 0점

### 힌트 페널티
- 힌트 사용: -100점
- 재확인: 0점 (추가 감점 없음)

### 예시
```
초기 점수: 1000점

라운드 2:
- P-1 힌트 확인: -100점 → 900점
- Q-2 정답: +100점 → 1000점

라운드 3:
- P-1 힌트 재확인: 0점 → 1000점 (무료)
- R-3 정답: +100점 → 1100점

최종 점수: 1100점
힌트 사용: 1회
```

## 🔄 실시간 업데이트

### Supabase Realtime 구독
- `relay_quiz_hint_usage` 테이블 변경 감지
- 힌트 사용 시 즉시 반영
- 팀 점수 실시간 업데이트

## ✅ 구현 완료 항목

- [x] 힌트 사용 기록 테이블
- [x] 힌트 페널티 시스템 (-100점)
- [x] 힌트 사용 함수
- [x] 사용 가능한 힌트 조회
- [x] 답안 제출 (힌트 정보 포함)
- [x] RLS 정책
- [x] 실시간 구독
- [x] 데이터베이스 마이그레이션

## 🎯 다음 단계

### UI 컴포넌트 구현
1. **RelayQuizPlayView** - 플레이어 화면
   - 현재 문제 표시
   - 이전 정답 힌트 영역
   - 힌트 확인 버튼
   - 답안 입력 및 제출

2. **RelayQuizAdmin** - 관리자 화면
   - 사이클 진행 관리
   - 팀별 진행 상황
   - 힌트 사용 통계

3. **RelayQuizScoreboard** - 점수판
   - 팀별 점수
   - 힌트 사용 현황
   - 진행 상황

---

**Relay Game의 핵심 메커니즘이 완성되었습니다! 🎉**